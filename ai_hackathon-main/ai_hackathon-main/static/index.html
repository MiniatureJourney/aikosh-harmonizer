<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-900">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIKosh Enterprise | Secure Data Harmonization</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .success-glow {
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.3);
        }

        .processing-pulse {
            animation: pulse-ring 2s cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite;
        }

        @keyframes pulse-ring {
            0% {
                box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.5);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(249, 115, 22, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(249, 115, 22, 0);
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }
    </style>
</head>

<body
    class="h-full text-slate-200 antialiased selection:bg-orange-500 selection:text-white overflow-hidden flex flex-col">

    <!-- Navbar -->
    <nav class="border-b border-slate-800 bg-slate-900/95 backdrop-blur z-50">
        <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-gradient-to-br from-orange-500 to-red-600 p-2 rounded-lg shadow-lg">
                        <i data-lucide="database" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <span
                            class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">
                            AIKosh<span class="font-light text-orange-500">Enterprise</span>
                        </span>
                    </div>
                </div>
                <div class="flex items-center gap-4 text-sm">
                    <div id="authSection" class="hidden items-center gap-2" style="display: none;">
                        <span id="authUser" class="text-slate-400 truncate max-w-[120px]"></span>
                        <button id="btnLogout" onclick="logout()" class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs">Logout</button>
                    </div>
                    <button id="btnLogin" class="hidden px-3 py-1.5 rounded-lg bg-orange-600 hover:bg-orange-500 text-white text-sm font-medium transition-colors">Login</button>
                    <div
                        class="flex items-center gap-2 px-3 py-1 rounded-full bg-green-900/20 border border-green-800/50 text-green-400">
                        <i data-lucide="shield-check" class="w-3 h-3"></i>
                        <span>Secure</span>
                    </div>
                    <div class="hidden md:flex gap-4 text-slate-400">
                        <span class="flex items-center gap-1"><i data-lucide="file-check"
                                class="w-4 h-4 text-orange-500"></i> Processed: <b id="statProcessed"
                                class="text-white ml-1">0</b></span>
                        <span class="flex items-center gap-1"><i data-lucide="zap" class="w-4 h-4 text-yellow-500"></i>
                            Avg Score: <b id="statScore" class="text-white ml-1">--</b></span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Layout -->
    <div class="flex flex-1 overflow-hidden relative">
        <!-- Sidebar -->
        <aside class="w-80 bg-slate-900 border-r border-slate-800 flex flex-col z-20 shadow-xl">
            <div class="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-900/50">
                <h2 class="font-semibold text-slate-300 flex items-center gap-2">
                    <i data-lucide="folder-open" class="w-4 h-4"></i> Workspace
                </h2>
                <div class="flex gap-2">
                    <button onclick="document.getElementById('fileInput').click()"
                        class="p-1.5 hover:bg-slate-800 rounded-md text-orange-500 transition-colors" title="Add Files">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                    </button>
                    <button onclick="clearAllFiles()"
                        class="p-1.5 hover:bg-slate-800 rounded-md text-red-400 transition-colors" title="Clear All">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
                <input type="file" id="fileInput" accept=".pdf,.csv,.xlsx,.xls" multiple hidden>
            </div>

            <!-- File List -->
            <div id="fileList" class="flex-1 overflow-y-auto p-3 space-y-2">
                <!-- Items injected here -->
            </div>

            <!-- Sidebar Footer -->
            <div class="p-4 border-t border-slate-800 bg-slate-900/50 space-y-3">
                <button id="downloadAllBtn" onclick="downloadBatch()" disabled
                    class="w-full flex items-center justify-center gap-2 py-2.5 px-4 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                    <i data-lucide="download" class="w-4 h-4"></i> Download All
                </button>
                <button id="synthesizeBtn" onclick="synthesizeBatch()" disabled
                    class="w-full flex items-center justify-center gap-2 py-2.5 px-4 bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white rounded-lg font-medium shadow-lg shadow-orange-900/20 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                    <i data-lucide="wand-2" class="w-4 h-4"></i> Synthesize Report
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main id="dropZone" class="flex-1 relative bg-slate-950 overflow-y-auto">

            <!-- Empty State -->
            <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center p-8 text-center">
                <div class="max-w-md w-full border-2 border-dashed border-slate-700 bg-slate-900/50 rounded-2xl p-12 transition-all hover:border-orange-500/50 hover:bg-slate-900 group cursor-pointer"
                    onclick="document.getElementById('fileInput').click()">
                    <div
                        class="mx-auto w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mb-6 group-hover:scale-110 transition-transform">
                        <i data-lucide="upload-cloud"
                            class="w-10 h-10 text-slate-400 group-hover:text-orange-500 transition-colors"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-white mb-2">Upload Data Files</h3>
                    <p class="text-slate-400 mb-6">Drag & drop PDF, CSV, or Excel files here<br>to start harmonization.
                    </p>
                    <span id="maxSizeHint"
                        class="inline-flex items-center gap-1 text-xs text-slate-500 bg-slate-800 px-3 py-1 rounded-full border border-slate-700">
                        <i data-lucide="info" class="w-3 h-3"></i> Max file size: <span id="maxSizeValue">25MB</span>
                    </span>
                </div>
            </div>

            <!-- Details View -->
            <div id="detailsView" class="hidden container mx-auto max-w-5xl p-8">
                <!-- Header -->
                <div class="flex justify-between items-start mb-8">
                    <div>
                        <div class="flex items-center gap-3 mb-2">
                            <h1 id="detTitle" class="text-3xl font-bold text-white tracking-tight">Document Title</h1>
                            <span id="detFormat"
                                class="px-2 py-0.5 rounded text-xs font-bold bg-slate-800 text-slate-400 border border-slate-700">PDF</span>
                        </div>
                        <p id="detDesc" class="text-slate-400 max-w-2xl leading-relaxed">No description available.</p>
                        <div id="detTags" class="flex flex-wrap gap-2 mt-4"></div>
                    </div>
                    <div class="text-right">
                        <div
                            class="inline-flex flex-col items-center justify-center w-24 h-24 rounded-2xl bg-slate-900 border border-slate-800 shadow-xl relative overflow-hidden group">
                            <div
                                class="absolute inset-0 bg-gradient-to-br from-green-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                            </div>
                            <span id="detScore" class="text-4xl font-bold text-green-500 relative z-10">0.9</span>
                            <span
                                class="text-[10px] uppercase tracking-wider text-slate-500 font-semibold mt-1 relative z-10">AI
                                Ready</span>
                        </div>
                    </div>
                </div>

                <!-- Cards Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <!-- Provenance Card -->
                    <div class="glass rounded-xl p-6">
                        <h3
                            class="text-xs font-bold text-orange-500 uppercase tracking-widest mb-4 flex items-center gap-2">
                            <i data-lucide="map-pin" class="w-3 h-3"></i> Provenance data
                        </h3>
                        <div class="space-y-4">
                            <div class="flex justify-between border-b border-slate-800 pb-2 last:border-0 last:pb-0">
                                <span class="text-slate-400 text-sm">Source</span>
                                <span id="detSource" class="font-medium text-white">--</span>
                            </div>
                            <div class="flex justify-between border-b border-slate-800 pb-2 last:border-0 last:pb-0">
                                <span class="text-slate-400 text-sm">Jurisdiction</span>
                                <span id="detJurisdiction" class="font-medium text-white">--</span>
                            </div>
                            <div class="flex justify-between border-b border-slate-800 pb-2 last:border-0 last:pb-0">
                                <span class="text-slate-400 text-sm">Data Owner</span>
                                <span id="detOwner" class="font-medium text-white">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- Technical Card -->
                    <div class="glass rounded-xl p-6">
                        <h3
                            class="text-xs font-bold text-blue-500 uppercase tracking-widest mb-4 flex items-center gap-2">
                            <i data-lucide="cpu" class="w-3 h-3"></i> Technical Specs
                        </h3>
                        <div class="space-y-4">
                            <div class="flex justify-between border-b border-slate-800 pb-2 last:border-0 last:pb-0">
                                <span class="text-slate-400 text-sm">Machine Readable</span>
                                <span id="detReadable" class="font-medium text-white">Yes</span>
                            </div>
                            <div class="flex justify-between border-b border-slate-800 pb-2 last:border-0 last:pb-0">
                                <span class="text-slate-400 text-sm">Granularity</span>
                                <span id="detGran" class="font-medium text-white">State</span>
                            </div>
                            <div class="flex justify-between border-b border-slate-800 pb-2 last:border-0 last:pb-0">
                                <span class="text-slate-400 text-sm">Original File</span>
                                <span id="detOrigName"
                                    class="font-medium text-white text-xs truncate max-w-[150px]">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Code Block -->
                <div class="glass rounded-xl overflow-hidden border border-slate-800">
                    <div class="bg-slate-900/80 px-4 py-3 border-b border-slate-800 flex justify-between items-center">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Metadata Output</span>
                        <div class="flex gap-3">
                            <button id="btnDownloadHarmonized" onclick="downloadHarmonized()"
                                class="hidden text-xs font-semibold text-green-400 hover:text-green-300 transition-colors flex items-center gap-1">
                                <i data-lucide="file-spreadsheet" class="w-3 h-3"></i> DOWNLOAD CSV
                            </button>
                            <button onclick="copyJSON()"
                                class="text-xs font-semibold text-orange-500 hover:text-orange-400 transition-colors flex items-center gap-1">
                                <i data-lucide="copy" class="w-3 h-3"></i> COPY JSON
                            </button>
                        </div>
                    </div>
                    <div class="bg-black/40 p-0">
                        <pre id="detJson" class="text-xs font-mono text-emerald-400 p-4 max-h-96 overflow-y-auto"></pre>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="hidden fixed inset-0 z-[200] flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden">
            <div class="p-6 border-b border-slate-800 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-white">Sign in</h3>
                <button onclick="closeAuthModal()" class="p-1 rounded hover:bg-slate-800 text-slate-400"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div id="authError" class="hidden text-sm text-red-400 bg-red-900/30 border border-red-800 rounded-lg px-3 py-2"></div>
                <div>
                    <label class="block text-xs font-medium text-slate-400 mb-1">Email</label>
                    <input type="email" id="authEmail" placeholder="you@example.com" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-white placeholder-slate-500 focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-xs font-medium text-slate-400 mb-1">Password</label>
                    <input type="password" id="authPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-white placeholder-slate-500 focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                </div>
                <div id="authNameGroup" class="hidden">
                    <label class="block text-xs font-medium text-slate-400 mb-1">Name (optional)</label>
                    <input type="text" id="authName" placeholder="Your name" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-white placeholder-slate-500 focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                </div>
                <div class="flex gap-2">
                    <button id="authSubmitLogin" onclick="submitLogin()" class="flex-1 py-2.5 px-4 rounded-lg bg-orange-600 hover:bg-orange-500 text-white font-medium">Login</button>
                    <button id="authSubmitRegister" onclick="submitRegister()" class="flex-1 py-2.5 px-4 rounded-lg bg-slate-700 hover:bg-slate-600 text-white font-medium">Register</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        lucide.createIcons();

        // --- STATE ---
        let filesQueue = [];
        let selectedFileId = null;
        let isProcessing = false;
        let maxUploadMb = 25;

        // --- ELEMENTS ---
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const fileListEl = document.getElementById('fileList');
        const detailsView = document.getElementById('detailsView');
        const emptyState = document.getElementById('emptyState');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const synthesizeBtn = document.getElementById('synthesizeBtn');

        // --- AUTH ---
        let authToken = localStorage.getItem('aikosh_token');
        let authEnabled = false;

        function getAuthHeaders() {
            const h = {};
            if (authToken) h['Authorization'] = 'Bearer ' + authToken;
            return h;
        }

        function openAuthModal() { document.getElementById('authModal').classList.remove('hidden'); document.getElementById('authError').classList.add('hidden'); if (typeof lucide !== 'undefined') lucide.createIcons(); }
        function closeAuthModal() { document.getElementById('authModal').classList.add('hidden'); if (typeof lucide !== 'undefined') lucide.createIcons(); }
        function showAuthError(msg) { const el = document.getElementById('authError'); el.textContent = msg; el.classList.remove('hidden'); }

        async function submitLogin() {
            const email = document.getElementById('authEmail').value.trim();
            const password = document.getElementById('authPassword').value;
            if (!email || !password) { showAuthError('Email and password required'); return; }
            try {
                const res = await fetch('/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
                if (!res.ok) { const d = await res.json().catch(() => ({})); showAuthError(d.detail || 'Login failed'); return; }
                const data = await res.json();
                authToken = data.access_token;
                localStorage.setItem('aikosh_token', authToken);
                closeAuthModal();
                updateAuthUI(true, data.user);
                showToast('Signed in', 'info');
            } catch (e) { showAuthError('Network error'); }
        }

        async function submitRegister() {
            const email = document.getElementById('authEmail').value.trim();
            const password = document.getElementById('authPassword').value;
            const name = document.getElementById('authName').value.trim() || null;
            if (!email || !password) { showAuthError('Email and password required'); return; }
            try {
                const res = await fetch('/auth/register', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password, name }) });
                if (!res.ok) { const d = await res.json().catch(() => ({})); showAuthError(d.detail || 'Registration failed'); return; }
                const data = await res.json();
                authToken = data.access_token;
                localStorage.setItem('aikosh_token', authToken);
                closeAuthModal();
                updateAuthUI(true, data.user);
                showToast('Account created', 'info');
            } catch (e) { showAuthError('Network error'); }
        }

        function logout() {
            authToken = null;
            localStorage.removeItem('aikosh_token');
            updateAuthUI(false);
            showToast('Signed out', 'info');
        }

        function updateAuthUI(loggedIn, user) {
            const btnLogin = document.getElementById('btnLogin');
            const authSection = document.getElementById('authSection');
            const authUser = document.getElementById('authUser');
            if (authEnabled) {
                if (loggedIn && user) { btnLogin.style.display = 'none'; authSection.style.display = 'flex'; authSection.classList.add('flex'); authUser.textContent = user.email; }
                else { btnLogin.style.display = 'block'; authSection.style.display = 'none'; }
            } else { btnLogin.style.display = 'none'; authSection.style.display = 'none'; }
        }

        // --- INIT: fetch health (max upload, auth_enabled) and auth/me
        fetch('/health').then(r => r.json()).then(d => {
            if (d.max_upload_mb) { maxUploadMb = d.max_upload_mb; const el = document.getElementById('maxSizeValue'); if (el) el.textContent = maxUploadMb + 'MB'; }
            authEnabled = !!d.auth_enabled;
            if (authEnabled) {
                document.getElementById('btnLogin').style.display = 'block';
                document.getElementById('btnLogin').onclick = openAuthModal;
                if (authToken) fetch('/auth/me', { headers: getAuthHeaders() }).then(r => r.json()).then(d => { if (d.user) updateAuthUI(true, d.user); else updateAuthUI(false); }).catch(() => updateAuthUI(false));
            }
        }).catch(() => {});

        // --- LISTENERS ---
        fileInput.addEventListener('change', e => addFiles(e.target.files));
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); });
        });
        dropZone.addEventListener('drop', e => { addFiles(e.dataTransfer.files); dropZone.classList.remove('ring-2', 'ring-orange-500'); });
        dropZone.addEventListener('dragenter', () => dropZone.classList.add('ring-2', 'ring-orange-500'));
        dropZone.addEventListener('dragleave', (e) => { if (!e.currentTarget.contains(e.relatedTarget)) dropZone.classList.remove('ring-2', 'ring-orange-500'); });
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); });

        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-[100] max-w-sm ' +
                (type === 'error' ? 'bg-red-900/90 text-red-100 border border-red-700' : 'bg-slate-800 text-slate-200 border border-slate-600');
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // --- LOGIC ---
        function addFiles(fileList) {
            const maxBytes = maxUploadMb * 1024 * 1024;
            let rejected = 0;
            Array.from(fileList).forEach(file => {
                if (file.size > maxBytes) { rejected++; return; }
                const id = Math.random().toString(36).substr(2, 9);
                filesQueue.push({ id, file, status: 'pending', data: null, errorMsg: null });
            });
            if (rejected) showToast(rejected + ' file(s) skipped: over ' + maxUploadMb + 'MB limit.', 'error');
            renderList();
            processQueue();
        }

        async function processQueue() {
            if (isProcessing) return;
            const next = filesQueue.find(f => f.status === 'pending');
            if (!next) { updateAggregateStats(); return; }

            isProcessing = true;
            next.status = 'processing';
            renderList();

            try {
                let endpoint = '/process-pdf';
                if (next.file.name.match(/\.(csv|xlsx|xls)$/i)) endpoint = '/harmonize';

                const formData = new FormData();
                formData.append('file', next.file);

                const res = await fetch(endpoint, { method: 'POST', body: formData, headers: getAuthHeaders() });
                if (res.status === 401) { authToken = null; localStorage.removeItem('aikosh_token'); updateAuthUI(false); showToast('Please sign in', 'error'); openAuthModal(); throw new Error('Please sign in'); }
                if (!res.ok) {
                    const errText = await res.text();
                    let msg = "Server Error " + res.status;
                    try {
                        const errJson = JSON.parse(errText);
                        const d = errJson.detail;
                        msg = (typeof d === 'string') ? d : (Array.isArray(d) && d[0]?.msg) ? d[0].msg : (d?.msg || msg);
                    } catch (e) { if (res.status === 413) msg = "File too large. Max size: " + maxUploadMb + "MB."; }
                    throw new Error(msg);
                }

                let json = await res.json();

                // POLLING LOGIC (with timeout)
                if (json.status === 'processing') {
                    const fileHash = json.file_hash;
                    const maxAttempts = 45; // 45 * 2s = 90s timeout
                    let attempts = 0;
                    while (attempts < maxAttempts) {
                        await new Promise(r => setTimeout(r, 2000));
                        const statusRes = await fetch(`/status/${fileHash}`, { headers: getAuthHeaders() });
                        if (!statusRes.ok) throw new Error("Polling failed");
                        json = await statusRes.json();

                        if (json.status === 'error') throw new Error(json.error_message || "Unknown Error");
                        if (json.catalog_info || json.metadata?.catalog_info || json._is_cached) break;
                        attempts++;
                    }
                    if (attempts >= maxAttempts) throw new Error("Processing timed out. Please try again.");
                }

                // Merge: file_hash/original_filename always; for PDF keep tables/lineage/confidence from top level
                const payload = json.metadata || json;
                next.data = {
                    ...payload,
                    file_hash: json.file_hash,
                    original_filename: json.original_filename,
                    ...(json.tables && { tables: json.tables }),
                    ...(json.lineage && { lineage: json.lineage }),
                    ...(json.confidence !== undefined && { confidence: json.confidence })
                };
                next.status = 'success';
                if (!selectedFileId) selectFile(next.id);

            } catch (err) {
                console.error(err);
                next.status = 'error';
                next.errorMsg = err.message;
            }

            isProcessing = false;
            renderList();
            processQueue();
        }

        function renderList() {
            fileListEl.innerHTML = '';
            filesQueue.forEach(item => {
                const el = document.createElement('div');
                const active = selectedFileId === item.id ? 'bg-slate-800 border-orange-500/50' : 'bg-slate-900 border-transparent hover:bg-slate-800';
                el.className = `p-3 rounded-lg border cursor-pointer group transition-all ${active}`;
                el.onclick = () => selectFile(item.id);

                let icon = '<i data-lucide="clock" class="w-4 h-4 text-slate-500"></i>';
                let statusColor = 'text-slate-500';

                if (item.status === 'processing') {
                    icon = '<i data-lucide="loader-2" class="w-4 h-4 text-orange-500 animate-spin"></i>';
                    statusColor = 'text-orange-500';
                } else if (item.status === 'success') {
                    icon = '<i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>';
                    statusColor = 'text-green-500';
                } else if (item.status === 'error') {
                    icon = '<i data-lucide="alert-circle" class="w-4 h-4 text-red-500"></i>';
                    statusColor = 'text-red-500';
                }

                el.innerHTML = `
                    <div class="flex items-center gap-3 mb-1">
                        ${icon}
                        <div class="font-medium text-sm text-slate-200 truncate flex-1">${item.file.name}</div>
                    </div>
                    ${item.status === 'error'
                        ? `<div class="flex items-center gap-2 pl-7"><span class="text-xs text-red-400 truncate flex-1">${item.errorMsg}</span><button onclick="retryFile('${item.id}')" class="flex-shrink-0 text-xs px-2 py-0.5 rounded bg-orange-600 hover:bg-orange-500 text-white">Retry</button></div>`
                        : `<div class="text-xs ${statusColor} pl-7 capitalize">${item.status}</div>`
                    }
                `;
                fileListEl.appendChild(el);
            });
            lucide.createIcons();

            const hasSuccess = filesQueue.some(f => f.status === 'success');
            downloadAllBtn.disabled = !hasSuccess;
            synthesizeBtn.disabled = !hasSuccess;
        }

        function selectFile(id) {
            selectedFileId = id;
            renderList();
            const item = filesQueue.find(f => f.id === id);
            if (!item) return;

            if (item.status === 'success' && item.data) {
                emptyState.classList.add('hidden');
                detailsView.classList.remove('hidden');
                renderDetails(item.data);
            } else if (item.status === 'error') {
                // Keep showing whatever was shown, or switch to empty state if nothing previously selected
            }
        }

        function renderDetails(meta) {
            const cat = meta.catalog_info || {};
            const prov = meta.provenance || {};
            const st = meta.spatial_temporal || {};
            const tech = meta.technical_metadata || {};

            document.getElementById('detTitle').innerText = cat.title || "Untitled Document";
            document.getElementById('detDesc').innerText = cat.description || "No description provided.";
            document.getElementById('detFormat').innerText = (tech.format || "FILE").toUpperCase();
            document.getElementById('detOrigName').innerText = meta.original_filename || "unknown";

            const tagsEl = document.getElementById('detTags');
            tagsEl.innerHTML = '';
            if (cat.sector) tagsEl.innerHTML += `<span class="px-2 py-1 rounded bg-orange-500/10 text-orange-400 text-xs font-semibold border border-orange-500/20">${cat.sector}</span>`;
            if (cat.keywords) cat.keywords.forEach(k => tagsEl.innerHTML += `<span class="px-2 py-1 rounded bg-slate-800 text-slate-400 text-xs border border-slate-700">${k}</span>`);

            document.getElementById('detScore').innerText = tech.ai_readiness_level || 0.0;
            document.getElementById('detSource').innerText = prov.source || "--";
            document.getElementById('detJurisdiction').innerText = prov.jurisdiction || "--";
            document.getElementById('detOwner').innerText = prov.data_owner || "--";
            document.getElementById('detReadable').innerText = tech.machine_readable ? "Yes" : "No";
            document.getElementById('detGran').innerText = st.granularity || "--";
            document.getElementById('detJson').innerText = JSON.stringify(meta, null, 2);

            // --- RICH VISUALIZATIONS ---

            // 1. Confidence (number from PDF pipeline or nested object)
            const confVal = typeof meta.confidence === 'number' ? meta.confidence : (meta.confidence?.overall_score ?? meta.technical_metadata?.ai_readiness_level);
            if (confVal != null) {
                const confColor = confVal > 0.8 ? 'text-green-500' : (confVal > 0.5 ? 'text-yellow-500' : 'text-red-500');
                document.getElementById('detScore').innerText = Number(confVal).toFixed(2);
                document.getElementById('detScore').className = `text-4xl font-bold ${confColor} relative z-10`;
            }

            // 2. Lineage Info (If available)
            if (meta.lineage) {
                document.getElementById('detSource').innerHTML = `
                    <div class="flex flex-col">
                        <span>${prov.source || "--"}</span>
                        <span class="text-xs text-slate-500">Method: ${meta.lineage.extraction_method || "Unknown"}</span>
                    </div>`;
            }

            // 3. Tables Rendering
            const codeBlock = document.getElementById('detJson').parentElement;
            // Reset to just JSON first
            codeBlock.innerHTML = `<pre id="detJson" class="text-xs font-mono text-emerald-400 p-4 max-h-96 overflow-y-auto">${JSON.stringify(meta, null, 2)}</pre>`;

            if (meta.tables && meta.tables.length > 0) {
                const tableContainer = document.createElement('div');
                tableContainer.className = "border-t border-slate-800 p-4 bg-slate-900/50";
                tableContainer.innerHTML = `<h4 class="text-xs font-bold text-blue-400 uppercase mb-3">Extracted Tables (${meta.tables.length})</h4>`;

                meta.tables.forEach((tbl, idx) => {
                    let html = `<div class="mb-4 last:mb-0 overflow-x-auto"><table class="w-full text-xs text-left text-slate-300 border-collapse">`;
                    // Heuristic: array of arrays or dict
                    if (Array.isArray(tbl.data)) {
                        tbl.data.forEach((row, rIdx) => {
                            html += `<tr class="${rIdx === 0 ? 'bg-slate-800 font-semibold text-white' : 'border-b border-slate-800 hover:bg-slate-800/50'}">`;
                            row.forEach(cell => html += `<td class="p-2 border border-slate-700">${cell || ''}</td>`);
                            html += `</tr>`;
                        });
                    }
                    html += `</table></div>`;
                    tableContainer.innerHTML += html;
                });
                codeBlock.appendChild(tableContainer);
            }

            const btn = document.getElementById('btnDownloadHarmonized');
            if (meta.file_hash) {
                btn.classList.remove('hidden');
                btn.dataset.hash = meta.file_hash;
            } else {
                btn.classList.add('hidden');
            }
        }

        function updateAggregateStats() {
            const successItems = filesQueue.filter(f => f.status === 'success');
            document.getElementById('statProcessed').innerText = successItems.length;
            if (successItems.length > 0) {
                const sum = successItems.reduce((acc, curr) => acc + (curr.data.technical_metadata?.ai_readiness_level || 0), 0);
                document.getElementById('statScore').innerText = (sum / successItems.length).toFixed(2);
            }
        }

        function downloadHarmonized() {
            const btn = document.getElementById('btnDownloadHarmonized');
            const hash = btn.dataset.hash;
            if (hash) {
                const url = `/download-harmonized/${hash}`;
                if (authToken) { const w = window.open('', '_blank'); fetch(url, { headers: getAuthHeaders() }).then(r => r.blob()).then(blob => { w.location.href = URL.createObjectURL(blob); }); }
                else window.open(url, '_blank');
            }
        }

        async function downloadBatch() {
            const zip = new JSZip();
            filesQueue.filter(f => f.status === 'success').forEach(item => {
                const name = item.file.name.replace(/\.[^/.]+$/, "") + ".json";
                zip.file(name, JSON.stringify(item.data, null, 2));
            });
            const content = await zip.generateAsync({ type: "blob" });
            saveAs(content, "aikosh_data_package.zip");
        }

        function retryFile(id) {
            const item = filesQueue.find(f => f.id === id);
            if (!item || item.status !== 'error') return;
            item.status = 'pending';
            item.errorMsg = null;
            renderList();
            processQueue();
        }

        function clearAllFiles() {
            if (confirm("Clear workspace?")) {
                filesQueue = [];
                selectedFileId = null;
                renderList();
                emptyState.classList.remove('hidden');
                detailsView.classList.add('hidden');
                updateAggregateStats();
            }
        }

        function copyJSON() {
            navigator.clipboard.writeText(document.getElementById('detJson').innerText);
            showToast('JSON copied to clipboard', 'info');
        }

        async function synthesizeBatch() {
            const successItems = filesQueue.filter(f => f.status === 'success');
            if (successItems.length < 2) return alert("Select at least 2 processed files.");

            const btn = document.getElementById('synthesizeBtn');
            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Generating...';

            try {
                const payload = successItems.map(f => f.data);
                const res = await fetch('/synthesize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error("Synthesis failed");

                const mergedData = await res.json();
                const id = "merged-" + Date.now();
                filesQueue.unshift({
                    id,
                    file: { name: "ðŸ“Š Merged_Report.json" },
                    status: 'success',
                    data: mergedData,
                    errorMsg: null
                });
                renderList();
                selectFile(id);
            } catch (e) {
                alert(e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="wand-2" class="w-4 h-4"></i> Synthesize Report';
                lucide.createIcons();
            }
        }
    </script>
</body>

</html>